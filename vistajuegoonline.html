<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asteroids - Online Lobby</title>
    
    <script>
        // Tu redirecci√≥n original
        if (window.location.protocol === "file:") {
            window.location.href = "http://localhost:3000/vistajuegoonline.html";
        }
    </script>
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; user-select: none; font-family: 'Courier New', monospace; color: white; text-align: center; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        .hidden { display: none !important; }
        
        /* Estilos de tus cajas de men√∫ */
        .menu-box { 
            position: relative;
            z-index: 10;
            margin: 100px auto; 
            padding: 20px; 
            border: 2px solid white; 
            width: 500px; 
            background: #111; 
        }

        button { 
            background: #000; 
            color: white; 
            border: 1px solid white; 
            padding: 10px 20px; 
            margin: 10px; 
            cursor: pointer; 
            font-family: 'Courier New', monospace; 
            font-weight: bold; 
            font-size: 16px;
        }
        button:hover { background: #333; }
        
        input { 
            padding: 10px; 
            font-family: 'Courier New', monospace; 
            text-align: center; 
            font-size: 18px; 
            text-transform: uppercase; 
            background: #000;
            color: #fff;
            border: 1px solid #fff;
        }
    </style>
</head>
<body>

    <div id="main-menu" class="menu-box">
        <h2>ASTEROIDS MULTIJUGADOR</h2>
        <button onclick="document.getElementById('main-menu').classList.add('hidden'); document.getElementById('create-room-menu').classList.remove('hidden');">CREAR SALA</button>
        <br><br>
        <input type="text" id="room-input" placeholder="C√ìDIGO" maxlength="4">
        <button onclick="joinRoom()">UNIRSE A SALA</button>
    </div>

    <div id="create-room-menu" class="menu-box hidden">
        <h2>CONFIGURAR SALA</h2>
        <button onclick="socket.emit('createRoom', 'Sala de Mando')">CONFIRMAR Y CREAR</button>
        <button onclick="location.reload()">VOLVER</button>
    </div>

    <div id="waiting-room-menu" class="menu-box hidden" style="border-color:#39ff14">
        <h2 id="waiting-room-name" style="color:#fff; margin-top:0; text-transform:uppercase;">SALA ESPACIAL</h2>
        <p>C√ìDIGO DE INVITACI√ìN:</p>
        
        <h1 id="waiting-room-code" style="color:#39ff14; font-size: 50px; letter-spacing: 10px; margin: 10px 0; user-select: text; cursor: text;">----</h1>
        
        <button id="copy-btn" onclick="copyRoomCode()" style="width: 65%; margin-top: 0; margin-bottom: 20px; font-size: 14px; padding: 8px;">üìã COPIAR C√ìDIGO</button>
        
        <p style="color:#aaa;">JUGADORES CONECTADOS: <span id="connected-count" style="color:#fff; font-weight:bold;">1</span></p>
        
        <div id="players-list" style="margin-bottom: 20px; font-size: 24px; letter-spacing: 5px;"></div>
        
        <button onclick="startGameAction()" style="border-color: #00f2ff; color: #00f2ff;">¬°EMPEZAR PARTIDA!</button>
        <button onclick="location.reload()" style="border-color: #ff0055; color: #ff0055;">SALIR</button>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        window.socket = io(); 
        var socket = window.socket;

        // ==========================================
        // L√ìGICA DE MEN√öS Y LOBBY
        // ==========================================

        function joinRoom() {
            const code = document.getElementById('room-input').value.trim().toUpperCase();
            if (code.length > 0) socket.emit('joinRoom', code);
        }

        function copyRoomCode() {
            const code = document.getElementById('waiting-room-code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.innerText = "¬°COPIADO! ‚úîÔ∏è";
                setTimeout(() => { btn.innerText = "üìã COPIAR C√ìDIGO"; }, 2000);
            });
        }

        function showWaitingRoom(code, name) {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('create-room-menu').classList.add('hidden');
            document.getElementById('waiting-room-menu').classList.remove('hidden');
            document.getElementById('waiting-room-code').innerText = code;
            document.getElementById('waiting-room-name').innerText = name.toUpperCase();
        }

        socket.on('roomCreated', (code) => {
            showWaitingRoom(code, "Tu Sala");
        });

        socket.on('roomJoined', (code, name) => {
            showWaitingRoom(code, name);
        });
        
        socket.on('errorMsg', (msg) => alert(msg));

        socket.on('updatePlayers', (serverPlayers) => {
            let count = Object.keys(serverPlayers).length;
            let listHTML = "";
            for (let id in serverPlayers) {
                listHTML += `<span style="color:${serverPlayers[id].color}">‚óè </span>`; 
            }
            document.getElementById('connected-count').innerText = count;
            document.getElementById('players-list').innerHTML = listHTML;
        });

        function startGameAction() {
            socket.emit('startGame');
        }

        // ==========================================
        // CAMBIO AL ARCHIVO DEL JUEGO
        // ==========================================
        socket.on('gameStarted', () => {
            // 1. Obtenemos el c√≥digo de la sala actual
            const code = document.getElementById('waiting-room-code').innerText;
            
            // 2. Lo guardamos en la "mochila" (sessionStorage)
            sessionStorage.setItem("codigoSala", code);
            
            // 3. Saltamos al archivo juegoonline.html
            window.location.href = "juegoonline.html";
        });

    </script>
</body>
</html>